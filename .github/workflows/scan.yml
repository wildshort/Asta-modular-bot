name: Daily Stock Scan

on:
  schedule:
    # Cron runs in UTC. 04:00 UTC = 09:30 IST; 09:45 UTC = 15:15 IST (Monâ€“Fri)
    - cron: "0 4 * * 1-5"
    - cron: "45 9 * * 1-5"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "daily-stock-scan"
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      PYTHONUNBUFFERED: "1"
      PYTHONPATH: ${{ github.workspace }}
      # If your scanner uses Telegram or other API keys, set them in
      # Settings â†’ Secrets and variables â†’ Actions, then uncomment:
      # TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      # TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run scanner
        run: |
          mkdir -p scanner/output
          # If your script supports --out, write a file we can upload:
          python scanner/stock_scanner.py --out scanner/output/latest.json || python scanner/stock_scanner.py

      - name: Write run summary
        run: |
          echo "## ðŸ§  Scan Summary" >> $GITHUB_STEP_SUMMARY
          # If your script supports a markdown summary flag, use it:
          if python scanner/stock_scanner.py --summary-md >> $GITHUB_STEP_SUMMARY 2>/dev/null; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_Rendered from --summary-md output_" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_No --summary-md support detected. Showing last 200 lines of logs:_" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 200 "$GITHUB_STEP_SUMMARY" 2>/dev/null || echo "Add --summary-md to your script for richer summaries."
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload scan artifact
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: scanner/output/*
          if-no-files-found: warn

